# Initial Exploration  

We don't even really know the best way to even start looking at these relationships, so this portion will contain some exploratory visualizations.  

So to start, I'm just going to pull out a few sites where I would expect to see some influence - sites that aren't in the bays, but are maybe around the edges. I'll hand-pick and hard-code, to figure out what this all even looks like, then figure out how to scale up.  

We have both precipitation data and hydrologic load data.  


```{r}
library(mapview)
library(sf)
library(tidyverse)
library(tmap)
library(tbeptools)
```

## Data Import  

Read in shapefiles and other data files here.  

```{r}
swfwmdpixels <- read_sf(here::here("GIS", "swfwmd_pixel_2_utm_m_83.shp"))
bay_segs <- read_sf(here::here("GIS", "TBEP-Bay_Segments.shp")) |> 
    st_transform(crs = st_crs(swfwmdpixels))

hydro <- readxl::read_xlsx(here::here("hydro-load-data",
                                      "monthly-hydrology.xlsx"))

hydro_sub <- hydro |> 
    dplyr::filter(year >= 2009)
```

Subset pixel file, merge datasets that need merging, turn into spatial objects.  

```{r}
precip_pixels <- st_intersection(swfwmdpixels, bay_segs)


# pixels to pull rainfall from,
# and their associated bay segments
# (for group-wise averaging)  
pixs <- precip_pixels |> 
    st_drop_geometry() |> 
    select(PIXEL, BAY_SEG)


# read in compiled rainfall (see R/rainfall_preprocessing.R)
prcp <- readRDS(here::here("SWFWMD-rainfall-data", "compiledRainfall.rds"))
prcp2 <- prcp |> 
    filter(PIXEL %in% unique(pixs$PIXEL))
# okaaaay, guess I managed to only pull Tampa Bay data anyway. Good check though.  
rm(prcp2)
```


Which precip to look at? Total for watershed? total within X kilometers of a station? (and what should X be?) Maybe one task is to figure out what's best. Could vary by watershed too though - Hillsborough Bay's is way bigger than Middle Tampa Bay's.... maybe a bigger time lag in situations like that (but still, if we're only looking at monthly....)


```{r}
# pull a few months and map both by pixel, 
# and averaged up to bay segment
# make sure it works  

# there are some pixels along bay segment boundaries
# I set this to be a full join so that the precip from
# those pixels goes into each bay segment average
# that they're part of

prcp <- prcp |> 
    full_join(pixs, by = "PIXEL",
              relationship = "many-to-many")

prcp_bayseg <- prcp |> 
    summarize(.by = c(BAY_SEG, month, year),
              inches = mean(inches, na.rm = TRUE)) |> 
    filter(year == 2022) |> 
    left_join(bay_segs) |> 
    st_as_sf()

prcp_pixel <- prcp |> 
    select(-BAY_SEG) |> 
    distinct() |> 
    filter(year == 2022) |> 
    left_join(select(precip_pixels, PIXEL, geometry)) |> 
    st_as_sf()
```

## Precip maps, comparing pixel-level to bay-segment-level  

```{r}
prcp_bayseg |> 
    filter(month == 1) |> 
    mapview(zcol = "inches",
            layer.name = "Jan 2022")

prcp_pixel |> 
    filter(month == 1) |> 
    mapview(zcol = "inches",
            layer.name = "Jan 2022")
```


```{r}
tm_shape(prcp_bayseg) +
    tm_borders() +
    tm_fill("inches",
            n = 6,
            palette = "YlGnBu") +
    tm_facets(by = "month", nrow = 4)

tm_shape(prcp_pixel) +
    tm_fill("inches",
            n = 6,
            palette = "YlGnBu") +
    tm_facets(by = "month", nrow = 4)

```

Variations throughout a year are so large that my worry about averaging up to bay segment being too rough is.... not really relevant after all. Should be fine.  

```{r}
prcp_bayseg <- prcp |> 
    summarize(.by = c(BAY_SEG, month, year),
              inches = mean(inches, na.rm = TRUE)) |> 
    filter(year == 2022) |> 
    left_join(bay_segs) |> 
    st_as_sf()

tm_shape(prcp_bayseg) +
    tm_borders() +
    tm_fill("inches",
            palette = "YlGnBu",
            n = 10) +
    tm_facets(by = c("month", "year"))
```

Bay segment level should be fine.  


## Precip and hydrologic loads  

I'd expect these to correlate pretty well. Wonder if that changes by month and/or wet vs. dry season. Check that out here.  

Subset to only the specific bay segments in both datasets (am unsure whether to average precip across different bay segments, which may be different sizes..... probably should do that at the pixel-to-bay-seg level if I want to)  

```{r}
combnd <- prcp |> 
    mutate(bay_segment = case_match(BAY_SEG,
                                    "Boca Ciega Bay" ~ "Remainder Lower Tampa Bay",
                                    "Manatee River" ~ "Remainder Lower Tampa Bay",
                                    "Terra Ceia Bay" ~ "Remainder Lower Tampa Bay",
                                    .default = BAY_SEG)) |> 
    summarize(.by = c(bay_segment, month, year),
              inches = mean(inches, na.rm = TRUE)) |> 
    filter(year >= 2009,
           bay_segment %in% unique(hydro$bay_segment)) |>
    left_join(hydro, by = c("bay_segment", "year", "month")) |> 
    rename(hydro_load = hy_load_106_m3_mo)
```

May have log-log relationships, or non-linear relationships, or need to look at it some different way. Let's see.  

```{r}
p <- ggplot(combnd) +
    geom_point(aes(x = inches, y = hydro_load,
                   col = bay_segment))

p
```

Generally positive relationship (as you'd expect) but lots of spread, especially at higher precipitation levels.  

Looks like a lot of that variability is due to the different bay segments.  

```{r}
p +
    facet_wrap(~bay_segment)
```

Hillsborough Bay has a lot of variability - not surprising since it's the biggest of the watersheds.  Looks like the relationships hold until about 12 inches, then higher points are both infrequent and possibly show some leveling off.  This includes ~15 years of data (2009 and later) and looks almost exactly the same as when I used only 2016 and above.    

```{r}
ggplot(combnd) +
    geom_point(aes(x = inches, y = hydro_load,
                   col = factor(month))) +
    scale_color_brewer(palette = "Paired") +
    facet_wrap(~bay_segment)
```

Makes sense that the relationship would vary by bay segment/watershed size. In Hillsborough Bay, we sort of see Aug-October on the high side of the hydrologic loads, even for the same amount of precipitation as in (e.g.) April.    

```{r}
ggplot(combnd) +
    geom_point(aes(x = inches, y = hydro_load,
                   col = bay_segment)) +
    scale_color_brewer(palette = "Set1") +
    facet_wrap(~month)
```

Varies a lot by month and bay segment, especially in September.  

```{r}
ggplot(combnd) +
    geom_boxplot(aes(x = factor(month), y = inches,
                    col = bay_segment)) +
    scale_color_brewer(palette = "Set1") +
    labs(title = "Precip variability by month x bay segment",
         x = "Month",
         y = "Monthly Total Precipitation (inches)")

ggplot(combnd) +
    geom_boxplot(aes(x = factor(month), y = hydro_load,
                    col = bay_segment)) +
    scale_color_brewer(palette = "Set1") +
    labs(title = "Hydro load variability by month x bay segment",
         x = "Month",
         y = "Monthly hydrologic load (10^6 m3)")
```

Precip is similar between watersheds; hydrologic load is highest in Hillsborough Bay and lowest in lower Tampa Bay. Middle and Old Tampa Bay are pretty comparable.  

# Hydrologic Loads and Enterococcus  


```{r}
fib_dat <- readRDS(here::here("fib-data", "tbeptools_importwqp.rds"))

fib_sub <- fib_dat |> 
    filter(yr >= 2009,
           class == "Estuary",
           var == "ecocci")

# get those attached to bay segments  
fib_baysegs <- fib_sub |> 
    st_as_sf(coords = c("Longitude", "Latitude"),
             crs = "WGS84",
             remove = FALSE) |>    # WGS84 is default for handheld GPS units
    st_transform(crs = st_crs(swfwmdpixels)) |> 
    st_intersection(bay_segs) |> 
    mutate(bay_segment = case_match(BAY_SEG,
                                    "Boca Ciega Bay" ~ "Remainder Lower Tampa Bay",
                                    "Manatee River" ~ "Remainder Lower Tampa Bay",
                                    .default = BAY_SEG))

fib_hydro <- left_join(fib_baysegs, combnd,
                       by = c("yr" = "year",
                              "mo" = "month",
                              "bay_segment"))
```

## Entero by monthly hydro load  

```{r}
ggplot(fib_hydro, aes(x = hydro_load,
                      y = val)) +
    geom_jitter(aes(col = factor(mo)),
               size = 2,
               alpha = 0.5) +
    geom_smooth() +
    geom_rug(col = "gray40") +
    scale_y_log10() +
    scale_x_log10() +
    facet_wrap(~bay_segment) +
    labs(title = "Entero vs. hydrologic load; log-log scale",
         x = "Hydrologic Load",
         y = "Enterococcus",
         col = "Month")
```

Interesting..... it's not necessarily the monthly hydrologic loads that matter (though it's clear that the higher hydrologic loads occur in certain months). Could come down to precipitation in some previous time periods.  

Could also be that because the majority of stations are in the bay proper, they're diluted and that's driving the lack-of-relationship. Really need to break this all out by "in-bay" vs. "have some land near the station".  

First a little more exploration of entero concentrations by time of year.  

## Entero by monthly precip  

```{r}
ggplot(fib_hydro, aes(x = inches,
                      y = val)) +
    geom_jitter(aes(col = factor(mo)),
               size = 2,
               alpha = 0.3) +
    geom_smooth() +
    geom_rug(col = "gray40") +
    scale_y_log10() +
    scale_x_log10() +
    facet_wrap(~bay_segment) +
    labs(title = "Entero vs. Monthly Precip",
         x = "Precipitation (in)",
         y = "Enterococcus",
         col = "Month")
```


We see it a bit more with precip rather than hydrologic load, at least in the higher values.  

## Entero by month  

```{r}
ggplot(fib_hydro,
       aes(x = factor(mo),
           y = val)) +
    geom_jitter(aes(col = factor(mo)),
                size = 0.7,
                alpha = 0.4) +
    geom_boxplot(alpha = 0) +
    scale_y_log10() +
    facet_wrap(~bay_segment) +
    labs(title = "Entero counts by month",
         x = "Month",
         y = "Enterococcus") +
    theme(legend.position = "none")
```

## Hydro load by month  

```{r}
ggplot(hydro_sub,
       aes(x = factor(month),
           y = hy_load_106_m3_mo)) +
    geom_jitter(aes(col = factor(month)),
                size = 0.7,
                alpha = 0.6) +
    geom_boxplot(alpha = 0) +
    scale_y_log10() +
    facet_wrap(~bay_segment) +
    labs(title = "Hydrologic Load by month",
         x = "Month",
         y = "Hydrologic Load") +
    theme(legend.position = "none")
```


## Precip by month  



# Inside bay vs. not  

```{r}
tbseg2 <- tbseg |> 
    st_transform(crs = st_crs(swfwmdpixels))

fib_nonbay <- st_filter(fib_hydro, st_union(tbseg2), .predicate = st_disjoint)
```

Note, this isn't good spatial coverage - may want to think about including freshwater sites too (eek).  

```{r}
mapview(fib_nonbay)
```

## Entero by month  

```{r}
ggplot(fib_nonbay,
       aes(x = factor(mo),
           y = val)) +
    geom_jitter(aes(col = factor(mo)),
                size = 0.7,
                alpha = 0.4) +
    geom_boxplot(alpha = 0) +
    scale_y_log10() +
    facet_wrap(~bay_segment) +
    labs(title = "Entero counts by month",
         subtitle = "stations that are not in the bay proper",
         x = "Month",
         y = "Enterococcus") +
    theme(legend.position = "none")
```

Still really not any cycling.... surprising. Maybe a little in Hillsborough Bay.  

## Entero by monthly hydro load  

```{r}
ggplot(fib_nonbay, aes(x = hydro_load,
                      y = val)) +
    geom_jitter(aes(col = factor(mo)),
               size = 2,
               alpha = 0.5) +
    geom_smooth() +
    geom_rug(col = "gray40") +
    scale_y_log10() +
    # scale_x_log10() +
    facet_wrap(~bay_segment) +
    labs(title = "Entero vs. hydrologic load",
         subtitle = "stations that are not in the bay proper",
         x = "Hydrologic Load",
         y = "Enterococcus",
         col = "Month")
```

```{r}
ggplot(fib_nonbay, aes(x = hydro_load,
                      y = val)) +
    geom_jitter(aes(col = bay_segment),
               size = 2,
               alpha = 0.5) +
    geom_smooth() +
    geom_rug(col = "gray40") +
    scale_y_log10() +
    scale_x_log10() +
    # facet_wrap(~bay_segment) +
    labs(title = "Entero vs. hydrologic load; log-log scale",
         subtitle = "stations that are not in the bay proper",
         x = "Hydrologic Load",
         y = "Enterococcus",
         col = "Month")
```


## Entero and precip  

```{r}
ggplot(fib_nonbay, aes(x = inches,
                      y = val)) +
    geom_jitter(aes(col = bay_segment),
               size = 2,
               alpha = 0.5) +
    geom_smooth() +
    geom_rug(col = "gray40") +
    scale_y_log10() +
    # scale_x_log10() +
    # facet_wrap(~bay_segment) +
    labs(title = "Entero vs. precip",
         subtitle = "stations that are not in the bay proper",
         x = "Precipitation (in)",
         y = "Enterococcus",
         col = "Month")
```

```{r}
ggplot(fib_nonbay, aes(x = inches,
                      y = val)) +
    geom_jitter(aes(col = bay_segment),
               size = 2,
               alpha = 0.5) +
    geom_smooth() +
    geom_rug(col = "gray40") +
    scale_y_log10() +
    # scale_x_log10() +
    facet_wrap(~bay_segment) +
    labs(title = "Entero vs. precip",
         subtitle = "stations that are not in the bay proper",
         x = "Precipitation (in)",
         y = "Enterococcus",
         col = "Month")

ggplot(fib_nonbay, aes(x = inches,
                      y = val)) +
    geom_jitter(aes(col = bay_segment),
               size = 2,
               alpha = 0.5) +
    geom_smooth() +
    geom_rug(col = "gray40") +
    scale_y_log10() +
    scale_x_log10() +
    facet_wrap(~bay_segment) +
    labs(title = "Entero vs. precip; log-log scale",
         subtitle = "stations that are not in the bay proper",
         x = "Precipitation (in)",
         y = "Enterococcus",
         col = "Month")
```

Changing the x-axis between log and 'regular' really changes how it looks.  


# A few individual sites  

OrgID 21FLHILL_WQX
Stations 22, 136, 036, 054



```{r}
fib_tiny <- fib_hydro |> 
    dplyr::filter(OrgID == "21FLHILL_WQX",
           Station %in% c("22", "136", "036", "054"))
mapview(fib_tiny)
```

## Time Series  

```{r}
fib_long <- fib_tiny |> 
    mutate(Date = lubridate::ymd(paste(yr, mo, "01"))) |> 
    rename(Entero = val) |> 
    select(OrgID, Station, Date, Entero, bay_segment, inches, hydro_load, geometry) |> 
    pivot_longer(c(Entero, inches, hydro_load),
                 names_to = "variable",
                 values_to = "value")
```

```{r}
ggplot(fib_long, aes(x = Date, y = value, col = Station)) +
    geom_point() +
    geom_line() +
    scale_y_log10() +
    facet_wrap(~variable, scales = "free_y",
               ncol = 1)
```

Well well well, we have at least one disappearing station, and it's one where enterococcus was generally high.  

```{r}
ggplot(fib_tiny, aes(x = inches, y = val, col = Station, group = Station)) +
    geom_point(size = 2, alpha = 0.7) +
    scale_y_log10() +
    geom_smooth(method = "lm", se = FALSE) +
    labs(x = "Precip",
         y = "Entero")
```

And really it looks like values within a station are sort of within their own range, different than other stations, as opposed to really correlating with precip (at least these few stations, on this graph).  Maybe a bit of a relationship if we force it to linear rather than loess.  

```{r}
ggplot(fib_tiny, aes(x = hydro_load, y = val, col = Station, group = Station)) +
    geom_point(size = 2, alpha = 0.7) +
    scale_y_log10() +
    geom_smooth(method = "lm", se = FALSE) +
    labs(x = "Hydro load",
         y = "Entero")
```


# experimentation  

```{r}
fib_tiny <- fib_hydro[c(1, 100, 400, 600, 2000, 5000, 8000, 10000), ]
mapview(fib_tiny)

nearBorder <- rowSums(st_is_within_distance(fib_tiny, tbseg2, dist = 10, sparse = FALSE))

fib_within_x <- fib_tiny[nearBorder > 0, ]
mapview(fib_within100) + mapview(tbseg2)
```

